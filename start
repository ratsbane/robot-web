#!/bin/bash

# Set -e: Exit immediately if a command exits with a non-zero status.
set -e

# Project directory
PROJECT_DIR="/var/www/robot"

# Activate the virtual environment
echo "Activating virtual environment..."
source "$PROJECT_DIR/venv/bin/activate"

# Check if the virtual environment is activated
if [ -z "$VIRTUAL_ENV" ]; then
    echo "Error: Virtual environment not activated."
    exit 1
fi

# Start robot_control_service.py in the background
echo "Starting robot_control_service.py..."
python3 "$PROJECT_DIR/robot_control_service.py" > "$PROJECT_DIR/robot_control_service.log" 2>&1 &
RCS_PID=$!  # Store the PID of the background process
echo "robot_control_service.py started with PID: $RCS_PID"

# Start websocket_server.py with Uvicorn in the background
echo "Starting websocket_server.py with Uvicorn..."
uvicorn websocket_server:app --host 0.0.0.0 --port 8000 > "$PROJECT_DIR/websocket_server.log" 2>&1 &
WSS_PID=$!
echo "websocket_server.py started with PID: $WSS_PID"

# Start web_server.py with Uvicorn
echo "Starting web_server.py with Uvicorn..."
uvicorn web_server:app --host 0.0.0.0 --port 5000 > "$PROJECT_DIR/web_server.log" 2>&1 &
WEB_PID=$!
echo "web_server.py started with PID: $WEB_PID"

echo "All services started."

# Keep the script running (so the background processes don't get killed)
echo "Press Ctrl+C to stop services (use stop_services.sh)."
wait #Wait indefinitely.
